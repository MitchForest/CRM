# Backend Reorganization Plan

## Objective
Separate SuiteCRM core from our customizations to enable clean upgrades and clear ownership of code.

## Proposed Structure

```
/backend/
├── suitecrm/                   # CORE: SuiteCRM installation (minimal modifications)
│   ├── config.php             # Generated by SuiteCRM installer
│   ├── config_override.php    # Our overrides (symlinked from custom)
│   ├── composer.json          # Original SuiteCRM composer (DO NOT MODIFY)
│   ├── custom/                # Will be replaced by symlinks/mounts to our custom
│   └── [core files...]        # Leave untouched for easy upgrades
│
├── custom/                     # OURS: All our enhancements and customizations
│   ├── api/                   # Custom API endpoints (currently custom-api)
│   ├── Extension/             # Module extensions (currently custom-extensions)
│   ├── modules/               # Module customizations
│   ├── services/              # Business logic services (OpenAI, Health, etc.)
│   ├── install/               # Installation scripts and seeds
│   ├── config/                # Our configuration files
│   ├── public/                # Public assets (JS embeds, etc.)
│   └── composer.json          # Our dependencies only
│
├── tests/                      # Test suites
├── scripts/                    # Utility scripts
├── .env                       # Environment configuration
└── composer.json              # Root composer that merges both
```

## Current State Analysis

### What We Have Now (Mess):
- `/backend/custom-api/` - Custom API implementation
- `/backend/custom-extensions/` - Module extensions
- `/backend/suitecrm-custom/` - Services and Phase 3 code
- `/backend/config/` - Configuration files
- `/backend/suitecrm/custom/` - Some customizations
- Multiple composer.json files with confusing names

### Problems:
1. Customizations scattered across 4 directories
2. Unclear separation between our code and SuiteCRM
3. Docker mounts are convoluted
4. Would be nightmare to upgrade SuiteCRM

## Migration Plan

### Phase 1: Create New Structure
```bash
# 1. Create the new custom directory structure
mkdir -p backend/custom/{api,Extension,modules,services,install,config,public}

# 2. Create root composer.json that uses composer-merge-plugin
cat > backend/composer.json << 'EOF'
{
    "name": "crm/backend",
    "description": "CRM Backend with SuiteCRM and Custom Extensions",
    "require": {
        "wikimedia/composer-merge-plugin": "^2.0"
    },
    "extra": {
        "merge-plugin": {
            "include": [
                "suitecrm/composer.json",
                "custom/composer.json"
            ],
            "recurse": false,
            "replace": false,
            "merge-dev": true
        }
    },
    "config": {
        "vendor-dir": "suitecrm/vendor"
    }
}
EOF

# 3. Create custom/composer.json for our dependencies
cat > backend/custom/composer.json << 'EOF'
{
    "name": "crm/custom",
    "description": "Custom CRM Extensions",
    "require": {
        "openai-php/client": "^0.7",
        "guzzlehttp/guzzle": "^7.5",
        "predis/predis": "^2.1",
        "league/html-to-markdown": "^5.1",
        "firebase/php-jwt": "^6.4"
    },
    "autoload": {
        "psr-4": {
            "Api\\": "custom/api/",
            "SuiteCRM\\Custom\\": "custom/"
        }
    }
}
EOF
```

### Phase 2: Move Files
```bash
# 1. Move API files
mv backend/custom-api/* backend/custom/api/

# 2. Move extensions
mv backend/custom-extensions/* backend/custom/Extension/

# 3. Move services and Phase 3 code
mv backend/suitecrm-custom/services backend/custom/
mv backend/suitecrm-custom/install backend/custom/
mv backend/suitecrm-custom/config/* backend/custom/config/

# 4. Move public assets
mkdir -p backend/custom/public/js
mv backend/suitecrm/public/js/{forms-embed,tracking,chat-widget}.js backend/custom/public/js/

# 5. Move config overrides
mv backend/config/config_override.php backend/custom/config/

# 6. Clean up empty directories
rm -rf backend/custom-api
rm -rf backend/custom-extensions  
rm -rf backend/suitecrm-custom
rm -rf backend/config
```

### Phase 3: Update Docker Configuration

```yaml
# docker-compose.yml
services:
  suitecrm:
    volumes:
      # Core SuiteCRM
      - ./backend/suitecrm:/var/www/html:rw
      
      # Mount our custom code into SuiteCRM structure
      - ./backend/custom/api:/var/www/html/custom/api:rw
      - ./backend/custom/Extension:/var/www/html/custom/Extension:rw
      - ./backend/custom/modules:/var/www/html/custom/modules:rw
      - ./backend/custom/services:/var/www/html/custom/services:rw
      - ./backend/custom/public:/var/www/html/public/custom:rw
      
      # Config override
      - ./backend/custom/config/config_override.php:/var/www/html/config_override.php:rw
      
      # Tests and environment
      - ./backend/tests:/var/www/html/tests:rw
      - ./backend/.env:/var/www/html/.env:ro
```

### Phase 4: Update File Paths

#### Files that need path updates:
1. **API Controllers** - Update service paths
   ```php
   // Old: require_once __DIR__ . '/../../suitecrm-custom/services/OpenAIService.php';
   // New: require_once __DIR__ . '/../services/OpenAIService.php';
   ```

2. **Configuration Loading**
   ```php
   // Old: require_once "/var/www/html/suitecrm-custom/config/ai_config.php"
   // New: require_once __DIR__ . '/../config/ai_config.php';
   ```

3. **Autoloader in API**
   ```php
   // Update custom/api/index.php
   require_once __DIR__ . '/../../vendor/autoload.php';
   ```

4. **Test Scripts** - Update paths to use new structure

### Phase 5: Update .gitignore

```gitignore
# SuiteCRM core (track only our modifications)
/backend/suitecrm/*
!/backend/suitecrm/.gitkeep

# But track our custom directory
!/backend/custom/

# Ignore vendor and cache
/backend/suitecrm/vendor/
/backend/suitecrm/cache/
/backend/suitecrm/upload/

# Environment
/backend/.env
```

### Phase 6: Documentation Updates

1. Update all documentation to reflect new structure
2. Create README in each major directory explaining its purpose
3. Update integration guide with new paths

## Benefits of This Approach

1. **Clean Separation**: Clear boundary between SuiteCRM and our code
2. **Easy Upgrades**: Can replace entire suitecrm directory without losing customizations
3. **Version Control**: Only track our code, not SuiteCRM core
4. **Docker Simplicity**: Straightforward volume mounts
5. **Developer Clarity**: Obvious where to put new code

## Rollback Plan

If issues arise:
1. Docker volumes preserve current state
2. Git has all custom code versioned
3. Can quickly restore by remapping volumes in docker-compose

## Testing Checklist

After migration:
- [ ] API health check endpoint responds
- [ ] Form submission works
- [ ] Activity tracking works
- [ ] Lead scoring works (with valid API key)
- [ ] Knowledge base search works
- [ ] All Phase 3 features functional
- [ ] Tests pass

## Timeline

1. **Backup Current State**: 30 min
2. **Create New Structure**: 30 min
3. **Move Files**: 1 hour
4. **Update Configurations**: 2 hours
5. **Testing & Fixes**: 2 hours

Total: ~6 hours

## Post-Migration

1. Delete old composer files:
   - `backend/composer-phase3-update.json`
   - `backend/suitecrm/composer-backend.json`

2. Update CI/CD pipelines if any

3. Update developer documentation

4. Consider making suitecrm a git submodule for even cleaner separation

---

This structure follows industry best practices for extending third-party applications while maintaining upgradeability.